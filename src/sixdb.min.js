/** 
 * @license
 * MIT LICENSE
 * 
 * Copyright (c) 2018 Juan Jose Capellan
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
var sixdb=function(_dbName){var db;var dbName=_dbName;this.getName=function(){return dbName};var consoleOff=false;this.setConsoleOff=function(off){if(typeof off=="boolean"){consoleOff=off}};var customOperator=function(value1,value2){return value1==value2};this.setCustomOperator=function(compareFunction){if(compareFunction){if(typeof compareFunction=="function"){if(compareFunction.length==2){customOperator=compareFunction}}}};function openDb(){var request=window.indexedDB.open(dbName);request.onerror=function(event){alert("Error. You must allow web app to use indexedDB.")};request.onsuccess=function(event){db=event.target.result;logger(logEnum.open);done()}}function lastRecords(storeName,maxResults,successCallback,errorCallback){var origin="get -> lastRecords(...)";var resultFiltered=[];var counter=0;var request=null;logger(logEnum.begin,[origin]);if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readonly",errorCallback);if(!store){checkTasks();return}var onsuccesCursorFunction=function(event){var cursor=event.target.result;if(cursor&&counter<maxResults){resultFiltered.push(cursor.value);counter++;cursor.continue()}else{successCallback(resultFiltered,origin);db.close();logger(logEnum.close);logger(logEnum.lastRecords,[counter,storeName]);done()}};var onsuccesGetAllFunction=function(event){successCallback(event.target.result,origin);db.close();logger(logEnum.close);logger(logEnum.getAll,[storeName]);done()};var onerrorFunction=function(event){requestErrorAction(origin,request.error,errorCallback)};if(maxResults!=null){try{request=store.openCursor(null,"prev").onsuccess=onsuccesCursorFunction}catch(e){db.close();logger(logEnum.close);errorSys.makeErrorObject(origin,20,request.error);logger(logEnum.error,[lastErrorObj]);taskQueue.shift();errorCallback(lastErrorObj);checkTasks()}request.onsuccess=onsuccesCursorFunction;request.onerror=onerrorFunction}else{request=tryStoreGetAll(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesGetAllFunction;request.onerror=onerrorFunction}}function getRecords(storeName,indexName,query,successCallback,errorCallback){var origin="get -> getRecords(...)";var index=null;logger(logEnum.begin,[origin]);if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readonly",errorCallback);if(!store){checkTasks();return}if(indexName){index=getIndex(origin,store,indexName,errorCallback);if(!index){checkTasks();return}}if(!indexName&&!query)getRecordsA(store,origin,successCallback,errorCallback);else if(!indexName&&query)getRecordsB(store,origin,query,successCallback,errorCallback);else if(indexName&&!query)getRecordsC(index,origin,successCallback,errorCallback);else if(indexName&&query)getRecordsD(index,origin,query,successCallback,errorCallback)}function getRecordsA(store,origin,successCallback,errorCallback){var request=null;var onsuccess=function(event){successCallback(event.target.result,origin);db.close();logger(logEnum.close);logger(logEnum.getAll,[store.name]);done()};var onerror=function(event){requestErrorAction(origin,request.error,errorCallback)};request=tryStoreGetAll(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccess;request.onerror=onerror}function getRecordsB(store,origin,query,successCallback,errorCallback){var counter=0;var resultFiltered=[];var request=null;var conditionsBlocksArray=qrySys.makeConditionsBlocksArray(query);var onsucces=function(event){var cursor=event.target.result;var extMode=conditionsBlocksArray[0].externalLogOperator;var test=false;var exitsInFirstTrue=extMode==null||extMode=="and"?false:true;if(cursor){test=testCursor(conditionsBlocksArray,exitsInFirstTrue,cursor);if(test){resultFiltered.push(cursor.value);counter++}cursor.continue()}else{successCallback(resultFiltered,origin,query);db.close();logger(logEnum.close);logger(logEnum.query,[query,counter,store.name]);done()}};var onerror=function(event){requestErrorAction(origin,request.error,errorCallback)};request=tryOpenCursor(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsucces;request.onerror=onerror}function getRecordsC(index,origin,successCallback,errorCallback){var request=null;var onsuccesGetAll=function(event){successCallback(event.target.result,origin);db.close();logger(logEnum.close);logger(logEnum.getAll,[index.objectStore.name]);done()};var onerrorFunction=function(event){requestErrorAction(origin,request.error,errorCallback)};request=tryIndexGetAll(origin,index,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesGetAll;request.onerror=onerrorFunction}function getRecordsD(index,origin,query,successCallback,errorCallback){var counter=0;var resultFiltered=[];var isIndexKeyValue=isKey(query);var request=null;var conditionsBlocksArray=!isIndexKeyValue?qrySys.makeConditionsBlocksArray(query):null;var onsuccesIndexGetKey=function(event){successCallback(event.target.result,origin,query);db.close();logger(logEnum.close);logger(logEnum.getByIndexKey,[query,index.name,index.objectStore.name]);done()};var onsuccesCursor=function(event){var cursor=event.target.result;var extMode=conditionsBlocksArray[0].externalLogOperator;var test=false;var exitsInFirstTrue=extMode==null||extMode=="and"?false:true;if(cursor){test=testCursor(conditionsBlocksArray,exitsInFirstTrue,cursor);if(test){resultFiltered.push(cursor.value);counter++}cursor.continue()}else{successCallback(resultFiltered,origin,query);db.close();logger(logEnum.close);logger(logEnum.query,[query,counter,index.objectStore.name]);done()}};var onerror=function(event){requestErrorAction(origin,request.error,errorCallback)};request=!isIndexKeyValue?tryOpenCursor(origin,index,errorCallback):tryIndexGetKey(origin,index,query,errorCallback);if(!request){checkTasks();return}request.onsuccess=isIndexKeyValue?onsuccesIndexGetKey:onsuccesCursor;request.onerror=onerror}function getaggregateFunction(storeName,indexName,query,property,aggregatefn,successCallback,errorCallback,origin){var index=null;logger(logEnum.begin,[origin]);if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readonly",errorCallback);if(!store){checkTasks();return}if(indexName!=null){index=getIndex(origin,store,indexName,errorCallback);if(!index){checkTasks();return}}if(!indexName&&!query)getaggregateFunctionA(store,origin,property,aggregatefn,successCallback,errorCallback);else if(!indexName&&query)getAggregateFunctionB(store,origin,query,property,aggregatefn,successCallback,errorCallback);else if(indexName&&!query)getaggregateFunctionA(index,origin,property,aggregatefn,successCallback,errorCallback);else if(indexName&&query)getAggregateFunctionB(index,origin,query,property,aggregatefn,successCallback,errorCallback)}function getaggregateFunctionA(store,origin,property,aggregatefn,successCallback,errorCallback){var request=null;var actualValue=null;var counter=0;var onsuccess=function(event){var cursor=event.target.result;if(cursor){if(cursor.value[property]){counter++;actualValue=aggregatefn(actualValue,cursor.value[property],counter)}cursor.continue()}else{successCallback(actualValue,origin);db.close();logger(logEnum.close);logger(logEnum.custom,["Result of "+origin+' on property "'+property+'": '+actualValue]);done()}};var onerrorFunction=function(event){requestErrorAction(origin,request.error,errorCallback)};request=tryOpenCursor(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccess;request.onerror=onerrorFunction}function getAggregateFunctionB(store,origin,query,property,aggregatefn,successCallback,errorCallback){var request=null;var actualValue=null;var isIndexKeyValue=isKey(query);if(isIndexKeyValue)query=store.keyPath+"="+query;var counter=0;var conditionsBlocksArray=qrySys.makeConditionsBlocksArray(query);var onsuccesCursor=function(event){var cursor=event.target.result;var extMode=conditionsBlocksArray[0].externalLogOperator;var test=false;var exitsInFirstTrue=extMode==null||extMode=="and"?false:true;if(cursor){test=testCursor(conditionsBlocksArray,exitsInFirstTrue,cursor);if(test){if(cursor.value[property]){counter++;actualValue=aggregatefn(actualValue,cursor.value[property],counter)}}cursor.continue()}else{successCallback(actualValue,origin,query);db.close();logger(logEnum.close);logger(logEnum.custom,["Result of "+origin+' on property "'+property+'": '+actualValue]);done()}};var onerrorFunction=function(event){requestErrorAction(origin,request.error,errorCallback)};request=tryOpenCursor(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesCursor;request.onerror=onerrorFunction}function newDB(errorCallback){var request=window.indexedDB.open(dbName);var origin="add -> newDB(...)";logger(logEnum.begin,[origin]);if(!errorCallback){errorCallback=function(){return}}var noDb=false;request.onupgradeneeded=function(event){noDb=true};request.onsuccess=function(event){var db=event.target.result;db.close();if(noDb){logger(logEnum.dbCreated)}else{logger(logEnum.dbExists)}done()};request.onerror=function(event){requestErrorAction(origin,request.error,errorCallback)}}function newStore(storeName,successCallback,errorCallback){var version;var origin="add -> newStore(...)";logger(logEnum.begin,[origin]);if(!errorCallback){errorCallback=function(){return}}if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}if(db.objectStoreNames.contains(storeName)){db.close();logger(logEnum.existStore,[storeName]);done();return}version=db.version;db.close();logger(logEnum.version);var newVersion=version+1;var store;request=window.indexedDB.open(dbName,newVersion);request.onupgradeneeded=function(event){db=event.target.result;try{store=db.createObjectStore(storeName,{keyPath:"nId",autoIncrement:true})}catch(e){requestErrorAction(origin,e,errorCallback);return}store.onerror=function(event){requestErrorAction(origin,event.target.error,errorCallback)}};request.onsuccess=function(event){if(successCallback){successCallback(event,origin)}db.close();logger(logEnum.newStore,[storeName]);done()}}function newRecord(storeName,obj,successCallback,errorCallback){var origin="add -> newRecord(...)";var request;logger(logEnum.begin,[origin]);if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readwrite",errorCallback);if(!store){checkTasks();return}var counter=0;if(Array.isArray(obj)){var i,objSize;objSize=obj.length;for(i=0;i<objSize;i++){request=store.add(obj[i]);request.onsuccess=function(event){counter++;if(counter==objSize){logger(logEnum.newRecord,[storeName]);if(successCallback){successCallback(event,origin)}db.close();logger(logEnum.close);done()}};request.onerror=function(event){requestErrorAction(origin,request.error,errorCallback)}}}else{request=store.add(obj);request.onsuccess=function(event){insertFinished(event)};request.onerror=function(event){requestErrorAction(origin,event.target.error,errorCallback)}}function insertFinished(event){logger(logEnum.newRecord,[storeName]);if(successCallback){successCallback(event,origin)}db.close();logger(logEnum.close);done()}}function newIndex(storeName,indexName,keyPath,successCallback,errorCallback){var version;var origin="add -> newIndex(...)";logger(logEnum.begin,[origin]);if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}version=db.version;db.close();logger(logEnum.version);var newVersion=version+1;request=window.indexedDB.open(dbName,newVersion);request.onupgradeneeded=function(event){db=event.target.result;var upgradeTransaction=event.target.transaction;try{var store=upgradeTransaction.objectStore(storeName)}catch(e){requestErrorAction(origin,e,errorCallback);return}if(!store.indexNames.contains(indexName)){store.createIndex(indexName,keyPath)}else{db.close();logger(logEnum.existIndex,[indexName,storeName]);done();return}};request.onsuccess=function(event){if(successCallback){successCallback(event,origin)}db.close();logger(logEnum.newIndex,[indexName,storeName]);done()};request.onerror=function(event){requestErrorAction(origin,request.error,errorCallback)}}function count(storeName,indexName,query,successCallback,errorCallback){var origin="get -> count(...)";logger(logEnum.begin,[origin]);var request=null;if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readonly",errorCallback);if(!store){checkTasks();return}var index;if(indexName!=null){index=getIndex(origin,store,indexName,errorCallback);if(!index){checkTasks();return}}var counter=0;if(!query){if(indexName)query=index.keyPath+"!= null";else query=store.keyPath+"!= -1"}var onSuccessQuery=function(event){var cursor=event.target.result;var conditionsBlocksArray=qrySys.makeConditionsBlocksArray(query);var extMode=conditionsBlocksArray[0].externalLogOperator;var exitsInFirstTrue=extMode==null||extMode=="and"?false:true;if(cursor){test=testCursor(conditionsBlocksArray,exitsInFirstTrue,cursor);if(test){counter++}cursor.continue()}else{if(successCallback){successCallback(counter,origin,query)}db.close();logger(logEnum.close);logger(logEnum.countQuery,[query,counter,storeName]);done()}};var onError=function(event){requestErrorAction(origin,request.error,errorCallback)};if(indexName){request=tryOpenCursor(origin,index,errorCallback);if(!request){checkTasks();return}request.onsuccess=onSuccessQuery;request.onerror=onError}else{request=tryOpenCursor(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onSuccessQuery;request.onerror=onError}}function delStore(storeName,successCallback,errorCallback){var version;var origin="del -> delStore(...)";logger(logEnum.begin,[origin]);if(!errorCallback){errorCallback=function(){return}}if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}version=db.version;db.close();logger(logEnum.version);var newVersion=version+1;request=window.indexedDB.open(dbName,newVersion);request.onupgradeneeded=function(event){db=event.target.result;db.deleteObjectStore(storeName)};request.onsuccess=function(event){if(successCallback){successCallback(event,origin)}db.close();logger(logEnum.delStore,[storeName]);done()};request.onerror=function(event){requestErrorAction(origin,request.error,errorCallback)}}function delDB(successCallback,errorCallback){var origin="del -> delDB(...)";logger(logEnum.begin,[origin]);if(!errorCallback){errorCallback=function(){return}}if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var request=window.indexedDB.deleteDatabase(dbName);request.onerror=function(event){requestErrorAction(origin,request.error,errorCallback)};request.onsuccess=function(event){if(successCallback){successCallback(event,origin)}logger(logEnum.delDb);done()}}function delRecords(storeName,indexName,query,successCallback,errorCallback){var origin="del -> delRecords(...)";logger(logEnum.begin,[origin]);var request=null;var isIndexKeyValue=false;if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readwrite",errorCallback);if(!store){checkTasks();return}var index;if(indexName!=null){index=getIndex(origin,store,indexName,errorCallback);if(!index){checkTasks();return}}isIndexKeyValue=isKey(query);var conditionsBlocksArray;conditionsBlocksArray=!isIndexKeyValue?qrySys.makeConditionsBlocksArray(query):null;var counter=0;var onsuccesCursor=function(event){var cursor=event.target.result;var extMode=conditionsBlocksArray[0].externalLogOperator;var test=false;var exitsInFirstTrue=extMode==null||extMode=="and"?false:true;if(cursor){test=testCursor(conditionsBlocksArray,exitsInFirstTrue,cursor);if(test){var request=cursor.delete();request.onsuccess=function(){counter++}}cursor.continue()}else{if(successCallback){successCallback(event,origin,query)}db.close();logger(logEnum.close);logger(logEnum.query,[query,counter,storeName]);done()}};var onerrorFunction=function(event){requestErrorAction(origin,request.error,errorCallback)};if(indexName!=null){if(isIndexKeyValue){query=index.keyPath+"="+query;conditionsBlocksArray=qrySys.makeConditionsBlocksArray(query)}request=tryOpenCursor(origin,index,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesCursor}else{request=tryOpenCursor(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesCursor}request.onerror=onerrorFunction}function delIndex(storeName,indexName,successCallback,errorCallback){var version;var origin="del -> delIndex(...)";logger(logEnum.begin,[origin]);if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}version=db.version;db.close();logger(logEnum.version);var newVersion=version+1;request=window.indexedDB.open(dbName,newVersion);request.onupgradeneeded=function(event){db=event.target.result;var upgradeTransaction=event.target.transaction;try{var store=upgradeTransaction.objectStore(storeName)}catch(e){requestErrorAction(origin,e,errorCallback);return}store.deleteIndex(indexName)};request.onsuccess=function(event){if(successCallback){successCallback(event,origin)}db.close();logger(logEnum.delIndex,[indexName,storeName]);done()};request.onerror=function(event){requestErrorAction(origin,request.error,errorCallback)}}function updateRecords(storeName,indexName,query,objectValues,successCallback,errorCallback){var origin="update -> updateRecords(...)";logger(logEnum.begin,[origin]);var isIndexKeyValue=false;var request=null;var i=0;if(!errorCallback)errorCallback=function(){return};if(errorSys.testArgs(origin,arguments)){invalidArgsAcction(errorCallback);return}var store=getStore(origin,storeName,"readwrite",errorCallback);if(!store){checkTasks();return}var index;if(indexName!=null){index=getIndex(origin,store,indexName,errorCallback);if(!index){checkTasks();return}}isIndexKeyValue=isKey(query);var conditionsBlocksArray;conditionsBlocksArray=!isIndexKeyValue?qrySys.makeConditionsBlocksArray(query):null;var counter=0;var onsuccesCursor=function(event){var cursor=event.target.result;var keys=Object.keys(objectValues);var newObjectValuesSize=keys.length;var extMode=conditionsBlocksArray?conditionsBlocksArray[0].externalLogOperator:null;var exitsInFirstTrue=extMode==null||extMode=="and"?false:true;if(cursor){var test=testCursor(conditionsBlocksArray,exitsInFirstTrue,cursor);if(test){var updateData=cursor.value;for(i=0;i<newObjectValuesSize;i++){updateData[keys[i]]=typeof objectValues[keys[i]]=="function"?objectValues[keys[i]](updateData[keys[i]]):objectValues[keys[i]]}var request=cursor.update(updateData);request.onsuccess=function(){counter++}}cursor.continue()}else{if(successCallback){successCallback(event,origin,query)}db.close();logger(logEnum.close);logger(logEnum.query,[query,counter,storeName]);done()}};var onerrorFunction=function(event){requestErrorAction(origin,request.error,errorCallback)};if(indexName!=null){if(isIndexKeyValue){query=index.keyPath+"="+query;conditionsBlocksArray=qrySys.makeConditionsBlocksArray(query)}request=tryOpenCursor(origin,index,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesCursor;request.onerror=onerrorFunction}else{request=tryOpenCursor(origin,store,errorCallback);if(!request){checkTasks();return}request.onsuccess=onsuccesCursor;request.onerror=onerrorFunction}}function getStore(origin,storeName,rwMode,errorCallback){try{var store=db.transaction(storeName,rwMode).objectStore(storeName)}catch(e){reportCatch(origin,e,errorCallback);return null}return store}function getIndex(origin,store,indexName,errorCallback){try{var index=store.index(indexName)}catch(e){reportCatch(origin,e,errorCallback);return null}return index}function tryStoreGetAll(origin,store,errorCallback){try{var request=store.getAll()}catch(e){reportCatch(origin,e,errorCallback);return null}return request}function tryIndexGetAll(origin,index,errorCallback){try{var request=index.getAll()}catch(e){reportCatch(origin,e,errorCallback);return null}return request}function tryIndexGetKey(origin,index,key,errorCallback){try{var request=index.getAll(key)}catch(e){reportCatch(origin,e,errorCallback);return null}return request}function tryOpenCursor(origin,openerObj,errorCallback){try{var request=openerObj.openCursor()}catch(e){reportCatch(origin,e,errorCallback);return null}return request}function reportCatch(origin,e,errorCallback){errorSys.makeErrorObject(origin,20,e);taskQueue.shift();db.close();errorCallback(lastErrorObj);logger(logEnum.error,[lastErrorObj])}function invalidArgsAcction(errorCallback){taskQueue.shift();db.close();errorCallback(lastErrorObj);logger(logEnum.error,[lastErrorObj]);checkTasks()}function requestErrorAction(origin,error,errorCallback){db.close();logger(logEnum.close);errorSys.makeErrorObject(origin,20,error);logger(logEnum.error,[lastErrorObj]);taskQueue.shift();errorCallback(lastErrorObj);checkTasks()}function testCursor(conditionsBlocksArray,exitsInFirst,cursor){var test=false;var i=0;var size=conditionsBlocksArray.length;for(i=0;i<size;i++){var conditions=conditionsBlocksArray[i].conditionsArray;var intMode=conditionsBlocksArray[i].internalLogOperator;test=qrySys.testConditionBlock(cursor,conditions,intMode);if(test==exitsInFirst){break}}return test}function isKey(query){var isKey=false;if(query){if(typeof query=="number"){isKey=true}else{isKey=query.match(qrySys.operatorRgx)?false:true}}return isKey}var qrySys={init:function(){this.blockRgx=/\(.*?(?=\))/g;this.blockOperatorRgx=/[\&\|]+(?=(\s*\())/g;this.operatorRgx=/(=|>|<|>=|<=|!=|<>|\^|\$|~~)+/g;this.rightOperandRgx=/(?:([=><\^\$~]))\s*["']?[^"']+["']?\s*(?=[&\|])|(?:[=><\^\$~])\s*["']?[^"']+["']?(?=$)/g;this.leftOperandRgx=/([^"'\s])(\w+)(?=\s*[=|>|<|!|\^|\$~])/g},makeConditionsBlocksArray:function(query){var t=this;var conditionsBlocksArray=[];var i=0;var blocks=query.match(t.blockRgx);if(blocks){t.deleteLeftParentheses(blocks)}var extLogOperator=query.match(t.blockOperatorRgx)?query.match(t.blockOperatorRgx):null;if(!blocks){t.pushConditionBlockToArray(query,null,conditionsBlocksArray);return conditionsBlocksArray}else{if(extLogOperator){if(extLogOperator=="&"||extLogOperator=="&&"){extLogOperator="and"}else{extLogOperator="or"}}for(i=0;i<blocks.length;i++){t.pushConditionBlockToArray(blocks[i],extLogOperator,conditionsBlocksArray)}return conditionsBlocksArray}},deleteLeftParentheses:function(blocks){var i=0;var size=blocks.length;for(i=0;i<size;i++){blocks[i]=blocks[i].substr(1)}},pushConditionBlockToArray:function(qry,extLogOperator,conditionsBlocksArray){var i=0;var t=this;var leftOperands=qry.match(t.leftOperandRgx);var rightOperands=qry.match(t.rightOperandRgx);for(i=0;i<rightOperands.length;i++){while(rightOperands[i][0].match(/[=><!\^\$~]/g)){rightOperands[i]=rightOperands[i].substr(1)}rightOperands[i]=rightOperands[i].replace(/["']/g,"").trim()}for(i=0;i<rightOperands.length;i++){qry=qry.replace(rightOperands[i],"")}var operators=qry.match(t.operatorRgx);var conditionsArray=[];if(leftOperands.length==1){conditionsArray.push({keyPath:leftOperands[0],cond:operators[0],value:rightOperands[0]});conditionsBlocksArray.push({conditionsArray:conditionsArray,internalLogOperator:null,externalLogOperator:extLogOperator});conditionsArray=null}else{var logOperatorsType=qry.match(/[\&\|]+/g)[0];if(logOperatorsType=="&"||logOperatorsType=="&&"){logOperatorsType="and"}else{logOperatorsType="or"}for(i=0;i<operators.length;i++){conditionsArray.push({keyPath:leftOperands[i],cond:operators[i],value:rightOperands[i]})}conditionsBlocksArray.push({conditionsArray:conditionsArray,internalLogOperator:logOperatorsType,externalLogOperator:extLogOperator});conditionsArray=null}},testConditionBlock:function(cursor,conditionsArray,operator){var t=this;var i=0;var test=operator=="and"||operator==null?true:false;if(operator=="and"||operator==null){for(i=0;i<conditionsArray.length;i++){test=t.testCondition(cursor.value[conditionsArray[i].keyPath],conditionsArray[i].cond,conditionsArray[i].value);if(!test)return false}}else{for(i=0;i<conditionsArray.length;i++){test=t.testCondition(cursor.value[conditionsArray[i].keyPath],conditionsArray[i].cond,conditionsArray[i].value);if(test)return true}}return test},testCondition:function(value1,condition,value2){var result;switch(condition){case"=":result=value1==value2?true:false;return result;case">":result=value1>value2?true:false;return result;case"<":result=value1<value2?true:false;return result;case">=":result=value1>=value2?true:false;return result;case"<=":result=value1<=value2?true:false;return result;case"!=":result=value1!=value2?true:false;return result;case"<>":if(typeof value1!="string"){return false}result=value1.indexOf(value2)!=-1;return result;case"^":if(typeof value1!="string"){return false}result=value1.indexOf(value2)==0;return result;case"$":if(typeof value1!="string"){return false}result=value1.indexOf(value2)==value1.length-value2.length;return result;case"~~":try{result=customOperator(value1,value2)}catch(e){result=false}return result;default:break}}};var idle=true;var taskQueue=[];var tkOpen={type:"openDb"};function done(){taskQueue.shift();checkTasks()}function checkTasks(){if(taskQueue.length==0){idle=true;logger(logEnum.noTask);return}idle=false;var type=taskQueue[0].type;var task=taskQueue[0];switch(type){case"openDb":openDb();break;case"newStore":newStore(task.storeName,task.successCallback,task.errorCallback);break;case"newRecords":newRecord(task.storeName,task.obj,task.successCallback,task.errorCallback);break;case"newDB":newDB(task.errorCallback);break;case"count":count(task.storeName,task.indexName,task.query,task.successCallback,task.errorCallback);break;case"custom":logger(logEnum.begin,["custom task"]);task.fn.apply(task.context,task.args);done();break;case"delStore":delStore(task.storeName,task.successCallback,errorCallback);break;case"delDB":delDB(task.successCallback,task.errorCallback);break;case"delRecords":delRecords(task.storeName,task.indexName,task.query,task.successCallback,task.errorCallback);break;case"delIndex":delIndex(task.storeName,task.indexName,task.successCallback,task.errorCallback);break;case"updateRecordsByIndex":updateRecords(task.storeName,task.indexName,task.query,task.objectValues,task.successCallback,task.errorCallback);break;case"newIndex":newIndex(task.storeName,task.indexName,task.keyPath,task.successCallback,task.errorCallback);break;case"lastRecords":lastRecords(task.storeName,task.maxResults,task.successCallback,task.errorCallback);break;case"getRecords":getRecords(task.storeName,task.indexName,task.query,task.successCallback,task.errorCallback);break;case"getAggregateFunction":getaggregateFunction(task.storeName,task.indexName,task.query,task.property,task.aggregatefn,task.successCallback,task.errorCallback,task.origin);break;default:break}}this.execTasks=function(){if(idle){checkTasks()}};this.add={db:function(errorCallback){var task={type:"newDB",errorCallback:errorCallback};taskQueue.push(task)},store:function(storeName,successCallback,errorCallback){var task={type:"newStore",storeName:storeName,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},records:function(storeName,obj,successCallback,errorCallback){var task={type:"newRecords",storeName:storeName,obj:obj,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},index:function(storeName,indexName,keyPath,successCallback,errorCallback){var task={type:"newIndex",storeName:storeName,indexName:indexName,keyPath:keyPath,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},customTask:function(fn,context,args){var argsArray=[];if(args){var i=0;for(i=2;i<arguments.length;i++){argsArray[2-i]=arguments[i]}}var task={type:"custom",fn:fn,context:context,args:argsArray};taskQueue.push(task)}};this.del={db:function(successCallback,errorCallback){var task={type:"delDB",successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(task)},store:function(storeName,successCallback,errorCallback){var task={type:"delStore",storeName:storeName,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},records:function(storeName,indexName,query,successCallback,errorCallback){var task={type:"delRecords",storeName:storeName,indexName:indexName,query:query,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},index:function(storeName,indexName,successCallback,errorCallback){var task={type:"delIndex",storeName:storeName,indexName:indexName,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)}};this.update={records:function(storeName,indexName,query,objectValues,successCallback,errorCallback){var task={type:"updateRecordsByIndex",storeName:storeName,indexName:indexName,query:query,objectValues:objectValues,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)}};this.get={lastRecords:function(storeName,maxResults,successCallback,errorCallback){var task={type:"lastRecords",storeName:storeName,maxResults:maxResults,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},records:function(storeName,indexName,query,successCallback,errorCallback){var task={type:"getRecords",storeName:storeName,indexName:indexName,query:query,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)},sum:function(storeName,indexName,query,property,successCallback,errorCallback){var aggregatefn=function(actual,selected){return actual+selected};var task={type:"getAggregateFunction",storeName:storeName,indexName:indexName,query:query,property:property,aggregatefn:aggregatefn,successCallback:successCallback,errorCallback:errorCallback,origin:"get -> Sum -> getaggregateFunction(...)"};taskQueue.push(tkOpen);taskQueue.push(task)},avg:function(storeName,indexName,query,property,successCallback,errorCallback){var aggregatefn=function(actual,selected,counter){return(actual*(counter-1)+selected)/counter};var task={type:"getAggregateFunction",storeName:storeName,indexName:indexName,query:query,property:property,aggregatefn:aggregatefn,successCallback:successCallback,errorCallback:errorCallback,origin:"get -> Average -> getaggregateFunction(...)"};taskQueue.push(tkOpen);taskQueue.push(task)},max:function(storeName,indexName,query,property,successCallback,errorCallback){var aggregatefn=function(actual,selected){return selected>actual?selected:actual};var task={type:"getAggregateFunction",storeName:storeName,indexName:indexName,query:query,property:property,aggregatefn:aggregatefn,successCallback:successCallback,errorCallback:errorCallback,origin:"get -> Max -> getaggregateFunction(...)"};taskQueue.push(tkOpen);taskQueue.push(task)},min:function(storeName,indexName,query,property,successCallback,errorCallback){var aggregatefn=function(actual,selected,counter){if(counter==1){actual=selected}return selected<actual&&counter>1?selected:actual};var task={type:"getAggregateFunction",storeName:storeName,indexName:indexName,query:query,property:property,aggregatefn:aggregatefn,successCallback:successCallback,errorCallback:errorCallback,origin:"get -> Min -> getaggregateFunction(...)"};taskQueue.push(tkOpen);taskQueue.push(task)},customAggregateFn:function(storeName,indexName,query,property,aggregatefn,successCallback,errorCallback){var task={type:"getAggregateFunction",storeName:storeName,indexName:indexName,query:query,property:property,aggregatefn:aggregatefn,successCallback:successCallback,errorCallback:errorCallback,origin:"get -> Custom -> getaggregateFunction(...)"};taskQueue.push(tkOpen);taskQueue.push(task)},count:function(storeName,indexName,query,successCallback,errorCallback){var task={type:"count",storeName:storeName,indexName:indexName,query:query,successCallback:successCallback,errorCallback:errorCallback};taskQueue.push(tkOpen);taskQueue.push(task)}};var logEnum={open:1,close:2,lastRecords:3,getAll:4,getByIndexKey:5,error:6,dbCreated:7,dbExists:8,query:9,noTask:10,newRecord:11,version:12,newIndex:13,newStore:14,delIndex:15,delStore:16,delDb:17,existIndex:18,existStore:19,countQuery:20,custom:21,begin:22,finish:23};function logger(t,args){if(consoleOff&&t!=6)return;switch(t){case 21:console.log(args[0]);break;case 22:console.log("//--- "+args[0]+" ----------------------------\x3e");break;case 23:console.log("<--------------- "+args[0]+" finished -------//");break;case 3:console.log(args[0]+' last records returned from store "'+args[1]+'"');break;case 4:console.log('All records returned from store "'+args[0]+'"');break;case 5:console.log('Records with key "'+args[0]+'" returned from index "'+args[1]+'" on object store "'+args[2]+'"');break;case 6:console.error(args[0]);break;case 7:console.log('Database "'+dbName+'" created');break;case 8:console.log('Database "'+dbName+'" already exists');break;case 9:console.log('Processed query: "'+args[0]+'" finished\n'+args[1]+' records returned from object store "'+args[2]+'"');break;case 10:console.log("No pending tasks");break;case 11:console.log('New record/s added to store "'+args[0]+'"');break;case 12:console.log("Database version tested");break;case 13:console.log('New index "'+args[0]+'" in store "'+args[1]+'"');break;case 14:console.log('New store "'+args[0]+'" created');break;case 15:console.log('Index "'+args[0]+'" deleted from store "'+args[1]+'"');break;case 16:console.log('Store "'+args[0]+'" deleted');break;case 17:console.log('Database "'+dbName+'" deleted');break;case 18:console.log('Index "'+args[0]+'" already exists in store "'+args[1]+'"');break;case 19:console.log('Store "'+args[0]+'" already exists');break;case 20:console.log('Processed query finished: "'+args[0]+'"\n'+args[1]+' records counted from the query to store: "'+args[2]+'"');break;default:break}}var lastErrorObj;var errorSys={codes:{1:"storeName must be a string",2:"storeName is null",3:"obj is null",4:"indexName is null",5:"indexName must be a string",6:"keyPath is null",7:"keyPath must be a string",8:"query is null",9:"query must be a string or a number",10:"objectValues is null",11:"objectValues must be an object",12:"maxResults must be a number or null",13:"successCallback is not a function",14:"errorCallback is not a function",15:"obj must be an object or an array of objects",16:"query must be an string",17:"the specified index does not exist",20:"IndexedDB error"},testArgs:function(origin,args){var errorId=0;switch(origin){case"get -> lastRecords(...)":errorId=this.testLastRecordsArgs(args);break;case"get -> getRecords(...)":errorId=this.testGetRecordsArgs(args);break;case"add -> newStore(...)":errorId=this.testNewStoreArgs(args);break;case"add -> newRecord(...)":errorId=this.testNewRecordArgs(args);break;case"add -> newIndex(...)":errorId=this.testNewIndexArgs(args);break;case"get -> count(...)":errorId=this.testCountArgs(args);break;case"del -> delStore(...)":errorId=this.testDelStoreArgs(args);break;case"del -> delDB(...)":errorId=this.testDelDBArgs(args);break;case"del -> delRecords(...)":errorId=this.testDelRecordsArgs(args);break;case"del -> delIndex(...)":errorId=this.testDelIndexArgs(args);break;case"update -> updateRecords(...)":errorId=this.testUpdateRecordsArgs(args);break;default:return false}if(errorId!=0)return this.makeErrorObject(origin,errorId);else return false},testStr:function(str){if(str){if(typeof str!="string"){this.test=1;return 1}}else{this.test=2;return 2}return false},testCallback:function(fn){if(fn){if(typeof fn!="function"){return false}return true}},makeErrorObject:function(origin,errorCode,domException){var errorObj={};if(!domException){errorObj.code=errorCode;errorObj.type=errorCode<17?"Invalid parameter":"IndexedDB error";errorObj.origin=origin;errorObj.description=this.codes[errorCode]}else{errorObj.code=20;errorObj.type=domException.name;errorObj.origin=origin;errorObj.description=domException.message}lastErrorObj=errorObj;return true},testLastRecordsArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(typeof args[1]!="number"&&args[1]!=null){errorId=12;break}if(!this.testCallback(args[2])){errorId=13;break}if(!this.testCallback(args[3])){errorId=14;break}errorId=0}return errorId},testGetRecordsArgs:function(args){var errorId=-1;var qtype=null;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(this.testStr(args[1])){if(this.test==1){errorId=5;break}}if(args[2]){qtype=typeof args[2];if(qtype!="string"&&qtype!="number"){errorId=9;break}}if(!this.testCallback(args[3])){errorId=13;break}if(!this.testCallback(args[4])){errorId=14;break}errorId=0}return errorId},testNewStoreArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(!this.testCallback(args[1])){errorId=13;break}if(!this.testCallback(args[2])){errorId=14;break}errorId=0}return errorId},testNewRecordArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(args[1]){if(typeof args[1]!="object"){errorId=15;break}}else{errorId=3;break}if(!this.testCallback(args[2])){errorId=13;break}if(!this.testCallback(args[3])){errorId=14;break}errorId=0}return errorId},testNewIndexArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(this.testStr(args[1])){errorId=this.test==1?5:4;break}if(this.testStr(args[2])){errorId=this.test==1?7:6;break}if(!this.testCallback(args[3])){errorId=13;break}if(!this.testCallback(args[4])){errorId=14;break}errorId=0}return errorId},testCountArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(args[1]){if(typeof args[1]!="string"){errorId=5;break}}if(args[2]){if(typeof args[2]!="string"){errorId=16;break}}if(!this.testCallback(args[3])){errorId=13;break}if(!this.testCallback(args[4])){errorId=14;break}errorId=0}return errorId},testDelStoreArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(!this.testCallback(args[1])){errorId=13;break}if(!this.testCallback(args[2])){errorId=14;break}errorId=0}return errorId},testDelDBArgs:function(args){var errorId=-1;while(errorId<0){if(!this.testCallback(args[0])){errorId=13;break}if(!this.testCallback(args[1])){errorId=14;break}errorId=0}return errorId},testDelRecordsArgs:function(args){var errorId=-1;var qtype=null;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(args[1]){if(typeof args[1]!="string"){errorId=5;break}}if(args[2]){qtype=typeof args[2];if(qtype!="string"&&qtype!="number"){errorId=9;break}}else{errorId=8;break}if(!this.testCallback(args[3])){errorId=13;break}if(!this.testCallback(args[4])){errorId=14;break}errorId=0}return errorId},testDelIndexArgs:function(args){var errorId=-1;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(this.testStr(args[1])){errorId=this.test==1?5:4;break}if(!this.testCallback(args[2])){errorId=13;break}if(!this.testCallback(args[3])){errorId=14;break}errorId=0}return errorId},testUpdateRecordsArgs:function(args){var errorId=-1;var qtype=null;while(errorId<0){if(this.testStr(args[0])){errorId=this.test==1?1:2;break}if(args[1]){if(typeof args[1]!="string"){errorId=5;break}}if(args[2]){qtype=typeof args[2];if(qtype!="string"&&qtype!="number"){errorId=9;break}}else{errorId=8;break}if(args[3]){if(typeof args[3]!="object"){errorId=11;break}}else{errorId=10;break}if(!this.testCallback(args[4])){errorId=13;break}if(!this.testCallback(args[5])){errorId=14;break}errorId=0}return errorId}};this.utils={pageFromArray:function(array,elementsPerPage,page){var pageArray=array.slice((page-1)*elementsPerPage,page*elementsPerPage);return pageArray}};qrySys.init();this.add.db();this.execTasks()};